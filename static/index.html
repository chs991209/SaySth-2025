<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>STT Whisper Base64 Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        #controls { margin-bottom: 20px; }
        textarea { width: 100%; height: 200px; margin-bottom: 10px; padding: 10px; border: 1px solid #ccc; }
        button { padding: 10px 20px; font-size: 16px; cursor: pointer; }
        #status { margin-top: 10px; font-weight: bold; color: blue; }
        #result { margin-top: 20px; padding: 15px; border: 1px solid #ccc; background-color: #f9f9f9; min-height: 50px; }
        #error { color: red; margin-top: 10px; }
    </style>
</head>
<body>
    <h1>STT Whisper Base64 직접 입력 테스트</h1>

    <div id="controls">
        <p>Base64 인코딩된 오디오 데이터 (JSON 형식의 "audio" 또는 "data" 키값)를 아래 텍스트 영역에 붙여넣으세요.</p>
        <textarea id="base64Input" placeholder='{"audio": "YOUR_BASE64_AUDIO_STRING_HERE"}'></textarea>
        <button id="sendButton">서버로 전송</button>
        <div id="status">데이터를 붙여넣고 전송 버튼을 누르세요.</div>
        <div id="error"></div>
    </div>

    <h2>STT 결과:</h2>
    <div id="result"></div>

    <script>
        const base64Input = document.getElementById('base64Input');
        const sendButton = document.getElementById('sendButton');
        const statusDiv = document.getElementById('status');
        const resultDiv = document.getElementById('result');
        const errorDiv = document.getElementById('error');

        const serverUrl = 'http://localhost:7666/stt_base64'; // FastAPI 서버 주소

        sendButton.addEventListener('click', async () => {
            const inputText = base64Input.value.trim();
            if (!inputText) {
                errorDiv.textContent = '입력 필드가 비어있습니다.';
                return;
            }

            statusDiv.textContent = '데이터 전송 중...';
            resultDiv.textContent = '';
            errorDiv.textContent = '';
            sendButton.disabled = true;

            try {
                // 입력된 텍스트가 유효한 JSON인지 파싱 시도
                let requestBody;
                try {
                    requestBody = JSON.parse(inputText);
                } catch (e) {
                    throw new Error('JSON 형식이 올바르지 않습니다. {"audio": "..."} 형식을 확인해주세요.');
                }

                // "audio" 또는 "data" 키가 있는지 확인
                if (!requestBody.audio && !requestBody.data) {
                    throw new Error('JSON 내에 "audio" 또는 "data" 키가 없습니다.');
                }

                const response = await fetch(serverUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody) // 파싱된 JSON 객체를 다시 문자열로 변환하여 전송
                });

                if (!response.ok) {
                    const errorResponseText = await response.text();
                    throw new Error(`HTTP 오류! 상태 코드: ${response.status}, 메시지: ${errorResponseText}`);
                }

                const data = await response.json();
                resultDiv.textContent = data.text;
                statusDiv.textContent = '성공적으로 변환되었습니다.';
            } catch (e) {
                console.error('STT 요청 중 오류 발생:', e);
                errorDiv.textContent = '오류 발생: ' + e.message;
                resultDiv.textContent = '오류로 인해 텍스트를 변환하지 못했습니다.';
            } finally {
                sendButton.disabled = false;
            }
        });
    </script>
</body>
</html>